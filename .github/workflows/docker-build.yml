name: Build and Verify Docker Streamlit Supervisor App

on:
  push:
    branches:
      - main

jobs:
  build-and-check:
    runs-on: ubuntu-latest

    env:
      DOCKER_IMAGE_NAME: chaos4455/vectorial-profiler:latest

    steps:
      - name: ğŸ“¦ Checkout do CÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Preparar Estrutura para Build
        run: |
          echo "ğŸ“ Preparando diretÃ³rio temporÃ¡rio para build..."
          mkdir -p dockerbuild/app
          cp -r * dockerbuild/app

      - name: ğŸ”§ Gerar Dockerfile Dinamicamente
        run: |
          echo "ğŸ”§ Gerando Dockerfile dinamicamente..."
          cat <<EOF > Dockerfile
          FROM ubuntu:22.04

          RUN apt-get update && \
              apt-get upgrade -y && \
              apt-get install -y python3 python3-pip curl git net-tools iputils-ping nano openssh-server supervisor && \
              pip3 install --no-cache-dir -r /app/requirements.txt

          # Configura SSH
          RUN useradd -m -s /bin/bash admin && \
              echo "admin:admin" | chpasswd && \
              echo "PermitRootLogin yes" >> /etc/ssh/sshd_config && \
              echo "PasswordAuthentication yes" >> /etc/ssh/sshd_config && \
              mkdir -p /var/run/sshd

          COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf
          COPY dockerbuild/app /app

          WORKDIR /app
          CMD ["/usr/bin/supervisord"]
          EOF

      - name: ğŸ§¾ Gerar supervisord.conf Dinamicamente
        run: |
          echo "ğŸ§¾ Gerando supervisord.conf dinamicamente..."
          cat <<EOF > supervisord.conf
          [supervisord]
          nodaemon=true

          [program:sshd]
          command=/usr/sbin/sshd -D
          autostart=true
          autorestart=true
          stdout_logfile=/var/log/supervisor/sshd.log
          stderr_logfile=/var/log/supervisor/sshd.err.log

          [program:streamlit-dashboard]
          command=python3 /app/streamlit-control-center-v1.py
          directory=/app
          autostart=true
          autorestart=true
          stdout_logfile=/var/log/supervisor/streamlit.log
          stderr_logfile=/var/log/supervisor/streamlit.err.log
          EOF

      - name: ğŸ”’ Login no Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u chaos4455 --password-stdin

      - name: ğŸ³ Build da Imagem Docker
        run: docker build -t $DOCKER_IMAGE_NAME .

      - name: ğŸš€ Subir Container
        run: |
          echo "ğŸš€ Iniciando container com portas expostas (8555, 8881, 8222)..."
          docker run -d --name vectorial-profiler -p 8555:8555 -p 8881:8881 -p 8222:22 $DOCKER_IMAGE_NAME
          sleep 15

      - name: ğŸ§  Verificar ServiÃ§os do Supervisor
        run: |
          echo "ğŸ” Checando status geral dos serviÃ§os:"
          docker exec vectorial-profiler supervisorctl status || echo "âŒ Supervisor falhou ao listar status."

      - name: ğŸ” Verificar se Streamlit estÃ¡ de pÃ© (porta 8555)
        run: |
          for i in {1..6}; do
            sleep 10
            echo "Tentando conexÃ£o com Streamlit (tentativa $i)..."
            if curl -s http://localhost:8555 | grep -iq "streamlit"; then
              echo "âœ… Streamlit subiu corretamente na porta 8555"
              break
            elif [ "$i" -eq 6 ]; then
              echo "âŒ Erro: Streamlit nÃ£o subiu corretamente na porta 8555 apÃ³s mÃºltiplas tentativas"
              echo "Coletando logs do container..."
              docker logs vectorial-profiler
              docker exec vectorial-profiler supervisorctl status
              docker exec vectorial-profiler cat /var/log/supervisor/supervisord.log || true
              exit 1
            fi
          done

      - name: ğŸ“„ Listar Processos Ativos no Container
        run: |
          echo "ğŸ“¦ Processos ativos dentro do container:"
          docker exec vectorial-profiler ps aux

      - name: ğŸªµ Coletar Logs do Supervisor
        run: |
          echo "ğŸ“‘ Logs do Supervisor dentro do container:"
          docker exec vectorial-profiler cat /var/log/supervisor/supervisord.log || echo "âŒ Falha ao coletar logs do Supervisor"

      - name: ğŸ” Verificar ConexÃ£o SSH no Container
        run: |
          echo "ğŸ” Testando conexÃ£o SSH local com admin:admin..."
          docker exec vectorial-profiler apt-get install -y openssh-client
          sleep 2
          docker exec vectorial-profiler bash -c "echo 'StrictHostKeyChecking no' >> /etc/ssh/ssh_config"
          docker exec vectorial-profiler sshpass -p admin ssh -p 22 admin@localhost 'echo "âœ… ConexÃ£o SSH local bem-sucedida"' || echo "âŒ Falha na conexÃ£o SSH local"

      - name: ğŸ§¼ Cleanup (opcional)
        if: always()
        run: docker rm -f vectorial-profiler || true
