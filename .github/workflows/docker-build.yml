name: üê≥ Build Docker Image - Replika AI

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  IMAGE_NAME: chaos4455/message-broker-replika
  GITHUB_REPO: chaos4455/projeto-message-broker-replika-ai-v1
  VERSION_TAG: latest

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: üì• Baixar c√≥digo do reposit√≥rio privado
        run: |
          git clone https://${{ secrets.MASTERTOKEN }}@github.com/${{ env.GITHUB_REPO }} app

      - name: üìÅ Criar Dockerfile dinamicamente
        run: |
          cat <<EOF > Dockerfile
          FROM ubuntu:22.04

          ARG GITHUB_PAT
          ENV DEBIAN_FRONTEND=noninteractive

          RUN apt-get update && \
              apt-get upgrade -y && \
              apt-get install -y python3 python3-pip ufw git net-tools curl iputils-ping nano openssh-server && \
              useradd -m -s /bin/bash replika && \
              echo 'replika:replika' | chpasswd && \
              ufw allow 22 && \
              ufw allow 8000 && \
              ufw allow 8080 && \
              ufw allow 8333 && \
              ufw allow 8777 && \
              ufw allow OpenSSH && \
              ufw --force enable && \
              mkdir -p /home/replika/app

          COPY ./app /home/replika/app

          WORKDIR /home/replika/app

          RUN pip3 install -r requirements.txt || true

          CMD bash -c "
            python3 message-broker-v3-clean.py & 
            sleep 5 && 
            python3 webdash3-clean.py & 
            sleep 5 && 
            python3 geramensagem-v3-massive-loop.py & 
            sleep 5 && 
            python3 coleta-mensagem-v3-batch-lote.py && 
            tail -f /dev/null"
          EOF

      - name: üîß Build da imagem Docker
        run: |
          docker build \
            --build-arg GITHUB_PAT=${{ secrets.MASTERTOKEN }} \
            -t $IMAGE_NAME:$VERSION_TAG .

      - name: üîê Login no Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üì§ Push da imagem para Docker Hub
        run: |
          docker push $IMAGE_NAME:$VERSION_TAG

      # - name: üè∑Ô∏è (Opcional) Criar tag de vers√£o - atualmente desativado
      #   run: |
      #     git config --global user.name "Elias Andrade - Replika AI"
      #     git config --global user.email "chaos4455@users.noreply.github.com"
      #     git tag RC1-beta-v0001
      #     git push https://x-access-token:${{ secrets.MASTERTOKEN }}@github.com/${{ env.GITHUB_REPO }} --tags
