name: üîß Build Docker Image Replika AI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  IMAGE_NAME: chaos4455/message-broker-replika
  VERSION: latest

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout reposit√≥rio
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: üõ†Ô∏è Configurar Dockerfile din√¢mico
      run: |
        cat <<EOF > Dockerfile
        FROM ubuntu:22.04

        ARG GITHUB_PAT
        ENV DEBIAN_FRONTEND=noninteractive

        RUN apt-get update && \
            apt-get upgrade -y && \
            apt-get install -y python3 python3-pip ufw git net-tools curl iputils-ping nano openssh-server && \
            useradd -m -s /bin/bash replika && \
            echo 'replika:replika' | chpasswd && \
            ufw allow 22 && \
            ufw allow 8000 && \
            ufw allow 8080 && \
            ufw allow 8333 && \
            ufw allow 8777 && \
            ufw allow OpenSSH && \
            ufw --force enable && \
            mkdir -p /home/replika/app

        WORKDIR /home/replika/app

        RUN git clone https://x-access-token:\${GITHUB_PAT}@github.com/chaos4455/projeto-message-broker-replika-ai-v1.git temp && \
            cp temp/*.py ./ && \
            rm -rf temp

        RUN pip3 install -r requirements.txt || true

        CMD bash -c "python3 message-broker-v3-clean.py & sleep 5 && python3 webdash3-clean.py & sleep 5 && python3 geramensagem-v3-massive-loop.py & sleep 5 && python3 coleta-mensagem-v3-batch-lote.py && tail -f /dev/null"
        EOF

    - name: üê≥ Build Docker Image
      run: |
        docker build \
          --build-arg GITHUB_PAT=${{ secrets.MASTERTOKEN }} \
          -t $IMAGE_NAME:$VERSION .

    - name: üê≥ Push to Docker Hub (opcional)
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}

    - name: üì§ Push imagem para Docker Hub (opcional)
      run: docker push $IMAGE_NAME:$VERSION

    # - name: üè∑Ô∏è Criar nova tag (desativado por enquanto)
    #   run: |
    #     git config --global user.name "Elias Andrade - Replika AI"
    #     git config --global user.email "chaos4455@users.noreply.github.com"
    #     git tag RC1-beta-v0001
    #     git push https://x-access-token:${{ secrets.MASTERTOKEN }}@github.com/chaos4455/projeto-message-broker-replika-ai-v1 --tags
