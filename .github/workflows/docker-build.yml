name: Build and Verify Docker Streamlit Supervisor App

on:
  push:
    branches:
      - main

jobs:
  build-and-check:
    runs-on: ubuntu-latest

    env:
      DOCKER_IMAGE_NAME: chaos4455/vectorial-profiler:latest

    steps:
      - name: 📦 Checkout do Código
        uses: actions/checkout@v3

      - name: 📁 Criação do Dockerfile Dinâmico
        run: |
          mkdir -p /home/replika/app
          cp -r * /home/replika/app

          cat <<EOF > Dockerfile
          FROM ubuntu:22.04

          RUN apt-get update && \
              apt-get upgrade -y && \
              apt-get install -y python3 python3-pip curl git net-tools iputils-ping nano openssh-server supervisor && \
              pip3 install --no-cache-dir -r /home/replika/app/requirements.txt

          COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

          WORKDIR /home/replika/app
          CMD ["/usr/bin/supervisord"]
          EOF

      - name: 🔒 Login no Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u chaos4455 --password-stdin

      - name: 🐳 Build da Imagem Docker
        run: docker build -t $DOCKER_IMAGE_NAME .

      - name: 🚀 Subir Container
        run: |
          docker run -d --name vectorial-profiler -p 8555:8555 -p 8881:8881 $DOCKER_IMAGE_NAME
          sleep 15

      - name: 🧠 Verificar Serviços do Supervisor
        run: |
          echo "🔍 Checando status geral dos serviços:"
          docker exec vectorial-profiler supervisorctl status || echo "❌ Supervisor falhou ao listar status."

      - name: 🔎 Verificar se Streamlit está de pé (porta 8555)
        run: |
          for i in {1..6}; do
            sleep 10
            echo "Tentando conexão com Streamlit (tentativa $i)..."
            if curl -s http://localhost:8555 | grep -iq "streamlit"; then
              echo "✅ Streamlit subiu corretamente na porta 8555"
              break
            elif [ "$i" -eq 6 ]; then
              echo "❌ Erro: Streamlit não subiu corretamente na porta 8555 após múltiplas tentativas"
              echo "Coletando logs do container..."
              docker logs vectorial-profiler
              docker exec vectorial-profiler supervisorctl status
              exit 1
            fi
          done

      - name: 📄 Listar Processos Ativos no Container
        run: |
          echo "📦 Processos ativos dentro do container:"
          docker exec vectorial-profiler ps aux

      - name: 🪵 Coletar Logs do Supervisor
        run: |
          echo "📑 Logs do Supervisor dentro do container:"
          docker exec vectorial-profiler cat /var/log/supervisor/supervisord.log || echo "❌ Falha ao coletar logs do Supervisor"

      - name: 🧼 Cleanup (opcional)
        if: always()
        run: docker rm -f vectorial-profiler || true
