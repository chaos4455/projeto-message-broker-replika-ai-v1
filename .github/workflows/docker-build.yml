name: ğŸš€ Build, Push and Deploy Docker Image

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: chaos4455/message-broker-replika
      VERSION: latest
      DOCKERHUB_USERNAME: chaos4455

    steps:
      - name: ğŸ§± Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ§¾ Create Dockerfile dynamically
        run: |
          cat <<EOF > Dockerfile
          FROM ubuntu:22.04
          ENV DEBIAN_FRONTEND=noninteractive

          RUN apt-get update && \
              apt-get upgrade -y && \
              apt-get install -y python3 python3-pip curl git net-tools iputils-ping nano openssh-server && \
              pip3 install requests && \
              useradd -m -s /bin/bash replika && \
              echo 'replika:replika' | chpasswd && \
              mkdir -p /home/replika/app

          WORKDIR /home/replika/app
          COPY . .

          CMD bash -c "\
            python3 message-broker-v3-clean.py & \
            sleep 5 && \
            python3 webdash3-clean.py & \
            sleep 5 && \
            python3 geramensagem-v3-massive-loop.py & \
            sleep 5 && \
            python3 coleta-mensagem-v3-batch-lote.py && \
            tail -f /dev/null"
          EOF

      - name: ğŸ³ Docker Login
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ› ï¸ Build Docker Image
        run: |
          docker build -t $IMAGE_NAME:$VERSION .

      - name: ğŸ“¤ Push Docker Image
        run: |
          docker push $IMAGE_NAME:$VERSION

      - name: ğŸš€ Run Docker Container to Validate Ports
        run: |
          docker run -d \
            --name message-broker-test \
            -p 8333:8333 \
            -p 8777:8777 \
            $IMAGE_NAME:$VERSION

          echo "âŒ› Aguardando subida dos serviÃ§os..."
          sleep 15

          echo "ğŸ” Verificando container em execuÃ§Ã£o:"
          docker ps

          echo "ğŸ§ª Verificando portas abertas:"
          ss -tuln | grep ':8333\|:8777' || echo "âŒ Portas nÃ£o detectadas!"

      - name: ğŸ§¹ Stop and Remove Test Container
        if: always()
        run: |
          docker stop message-broker-test || true
          docker rm message-broker-test || true
