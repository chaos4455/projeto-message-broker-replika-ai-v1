name: üöÄ Build & Push Docker Image

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout do c√≥digo
      uses: actions/checkout@v4

    - name: üîê Login no Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: üìù Criar Dockerfile dinamicamente
      run: |
        cat <<'EOF' > Dockerfile
        FROM ubuntu:22.04

        # --- Atualiza e instala depend√™ncias essenciais ---
        RUN apt-get update && apt-get install -y \
            python3 python3-pip \
            gcc libpq-dev build-essential \
            openssh-server sudo ufw \
            nano vim htop iftop net-tools curl wget unzip iputils-ping \
            libpam0g-dev libpam-modules && \
            apt-get clean

        # --- Cria usu√°rio admin com permiss√£o sudo ---
        RUN useradd -m -s /bin/bash admin && echo 'admin:admin' | chpasswd && \
            echo 'admin ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

        # --- Ativa o SSH ---
        RUN mkdir /var/run/sshd

        # --- Hardening SSH ---
        RUN sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config && \
            sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
            sed -i 's/^#\?UsePAM.*/UsePAM yes/' /etc/ssh/sshd_config && \
            sed -i 's/^#\?PermitEmptyPasswords.*/PermitEmptyPasswords no/' /etc/ssh/sshd_config

        # --- Ativa UFW e libera portas ---
        RUN ufw allow 22 && \
            ufw allow 8000 && \
            ufw allow 8080 && \
            ufw allow 8333 && \
            ufw allow 8777 && \
            ufw allow OpenSSH && \
            ufw --force enable

        # --- Define diret√≥rio de trabalho ---
        WORKDIR /app

        # --- Copia os arquivos do projeto ---
        COPY requirements.txt .
        COPY message-broker-v3-clean.py .

        # --- Instala depend√™ncias Python ---
        RUN pip3 install --no-cache-dir -r requirements.txt

        # --- Exp√µe as portas ---
        EXPOSE 22 8000 8080 8333 8777

        # --- Inicia SSH + App ---
        CMD service ssh start && python3 message-broker-v3-clean.py
        EOF

    - name: üèóÔ∏è Build da imagem Docker
      run: |
        docker build -t chaos4455/message-broker-v3:latest .

    - name: üöÄ Push para o Docker Hub
      run: |
        docker push chaos4455/message-broker-v3:latest
